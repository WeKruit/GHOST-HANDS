name: CI/CD

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

env:
  BUN_VERSION: "1.2"
  NODE_VERSION: "20"

jobs:
  # Type checking
  typecheck:
    name: Type Check
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: oven-sh/setup-bun@v2
        with:
          bun-version: ${{ env.BUN_VERSION }}
      - run: bun install --frozen-lockfile
      - run: bun run build

  # Unit tests
  test-unit:
    name: Unit Tests
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: oven-sh/setup-bun@v2
        with:
          bun-version: ${{ env.BUN_VERSION }}
      - run: bun install --frozen-lockfile
      - run: bun run test:unit

  # Integration tests
  test-integration:
    name: Integration Tests
    runs-on: ubuntu-latest
    needs: [typecheck]
    steps:
      - uses: actions/checkout@v4
      - uses: oven-sh/setup-bun@v2
        with:
          bun-version: ${{ env.BUN_VERSION }}
      - run: bun install --frozen-lockfile
      - run: bun run test:integration
        env:
          SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
          SUPABASE_SERVICE_KEY: ${{ secrets.SUPABASE_SERVICE_KEY }}
          SUPABASE_DIRECT_URL: ${{ secrets.SUPABASE_DIRECT_URL }}
          GH_SERVICE_SECRET: ${{ secrets.GH_SERVICE_SECRET }}
          GH_ENCRYPTION_KEY: ${{ secrets.GH_ENCRYPTION_KEY }}

  # Docker build + push to ECR
  docker:
    name: Docker Build & Push
    runs-on: ubuntu-latest
    needs: [typecheck, test-unit]
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    outputs:
      image_tag: ${{ github.sha }}
      ecr_image: ${{ steps.ecr-login.outputs.registry }}/${{ secrets.ECR_REPOSITORY }}:${{ github.sha }}
    steps:
      - uses: actions/checkout@v4

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ secrets.AWS_REGION }}

      - name: Login to ECR
        id: ecr-login
        uses: aws-actions/amazon-ecr-login@v2

      - name: Build and push Docker image
        env:
          ECR_REGISTRY: ${{ steps.ecr-login.outputs.registry }}
          ECR_REPOSITORY: ${{ secrets.ECR_REPOSITORY }}
          IMAGE_TAG: ${{ github.sha }}
        run: |
          docker build -t $ECR_REGISTRY/$ECR_REPOSITORY:$IMAGE_TAG -t $ECR_REGISTRY/$ECR_REPOSITORY:latest .
          docker push $ECR_REGISTRY/$ECR_REPOSITORY:$IMAGE_TAG
          docker push $ECR_REGISTRY/$ECR_REPOSITORY:latest

  # Notify VALET that a new image is ready for deployment
  # VALET controls the EC2 fleet and triggers rolling updates
  notify-valet:
    name: Notify VALET
    runs-on: ubuntu-latest
    needs: [docker, test-integration]
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    steps:
      - name: Send deploy-ready webhook to VALET
        env:
          VALET_DEPLOY_WEBHOOK_URL: ${{ secrets.VALET_DEPLOY_WEBHOOK_URL }}
          VALET_DEPLOY_WEBHOOK_SECRET: ${{ secrets.VALET_DEPLOY_WEBHOOK_SECRET }}
          ECR_REGISTRY: ${{ secrets.ECR_REGISTRY }}
          ECR_REPOSITORY: ${{ secrets.ECR_REPOSITORY }}
          IMAGE_TAG: ${{ github.sha }}
        run: |
          if [ -z "$VALET_DEPLOY_WEBHOOK_URL" ]; then
            echo "::warning::VALET_DEPLOY_WEBHOOK_URL not configured. Skipping webhook notification."
            echo "Image pushed to ECR: ${ECR_REGISTRY}/${ECR_REPOSITORY}:${IMAGE_TAG}"
            exit 0
          fi

          PAYLOAD=$(cat <<EOF
          {
            "event": "ghosthands.deploy_ready",
            "image": "${ECR_REGISTRY}/${ECR_REPOSITORY}:${IMAGE_TAG}",
            "image_tag": "${IMAGE_TAG}",
            "image_latest": "${ECR_REGISTRY}/${ECR_REPOSITORY}:latest",
            "commit_sha": "${GITHUB_SHA}",
            "commit_message": $(echo "${{ github.event.head_commit.message }}" | head -1 | jq -Rs .),
            "branch": "main",
            "repository": "${{ github.repository }}",
            "run_id": "${{ github.run_id }}",
            "run_url": "${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}",
            "timestamp": "$(date -u +%Y-%m-%dT%H:%M:%SZ)"
          }
          EOF
          )

          # Generate HMAC signature for webhook verification
          SIGNATURE=$(echo -n "$PAYLOAD" | openssl dgst -sha256 -hmac "$VALET_DEPLOY_WEBHOOK_SECRET" | awk '{print $2}')

          echo "Notifying VALET of new GhostHands image: ${IMAGE_TAG}"

          HTTP_STATUS=$(curl -s -o /tmp/webhook_response.txt -w "%{http_code}" \
            -X POST "$VALET_DEPLOY_WEBHOOK_URL" \
            -H "Content-Type: application/json" \
            -H "X-GH-Webhook-Signature: sha256=${SIGNATURE}" \
            -H "X-GH-Event: deploy_ready" \
            --max-time 30 \
            -d "$PAYLOAD")

          echo "VALET responded with HTTP ${HTTP_STATUS}"
          cat /tmp/webhook_response.txt

          if [ "$HTTP_STATUS" -ge 200 ] && [ "$HTTP_STATUS" -lt 300 ]; then
            echo "VALET notified successfully. Deployment will be managed by VALET."
          else
            echo "::warning::VALET webhook returned HTTP ${HTTP_STATUS}. VALET may not have received the deploy notification."
            echo "Manual deploy may be required: ECR_IMAGE=${ECR_REGISTRY}/${ECR_REPOSITORY}:${IMAGE_TAG}"
            # Don't fail the pipeline â€” the image is in ECR and can be deployed manually
          fi
